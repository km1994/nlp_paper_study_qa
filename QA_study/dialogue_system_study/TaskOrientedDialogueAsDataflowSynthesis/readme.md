# 【关于 用数据流合成实现任务型对话 】那些你不知道的事

> 作者：杨夕
> 
> 项目地址：https://github.com/km1994/nlp_paper_study
> 
> 个人介绍：大佬们好，我叫杨夕，该项目主要是本人在研读顶会论文和复现经典论文过程中，所见、所思、所想、所闻，可能存在一些理解错误，希望大佬们多多指正。【本文章仅作为个人学习笔记用，如有侵权，麻烦联系删除！】
> 
> 论文:Task-Oriented Dialogue as Dataflow Synthesis
> 
> 论文地址：https://www.mitpressjournals.org%2Fdoi%2Fpdf%2F10.1162%2Ftacl_a_00333
> 
> 参考于 [解读微软最新的智能对话技术：用数据流合成实现任务型对话](https://zhuanlan.zhihu.com/p/245081650)



## 目录

- [【关于 用数据流合成实现任务型对话 】那些你不知道的事](#关于-用数据流合成实现任务型对话-那些你不知道的事)
  - [目录](#目录)
  - [动机](#动机)
  - [对话系统的三个挑战 何在？](#对话系统的三个挑战-何在)
  - [现有 主流的任务型对话系统技术 介绍](#现有-主流的任务型对话系统技术-介绍)
    - [意图识别和槽填充](#意图识别和槽填充)
    - [意图识别的局限性](#意图识别的局限性)
      - [问题一：长尾语句](#问题一长尾语句)
      - [问题二：上下文理解](#问题二上下文理解)
      - [问题三：跨领域作业](#问题三跨领域作业)
  - [解决方法：程序合成](#解决方法程序合成)
    - [举例说明](#举例说明)
    - [程序合成的难点](#程序合成的难点)
      - [程序合成的难点：标注和解析](#程序合成的难点标注和解析)
    - [程序合成的突破点：设计对话系统专属的语言](#程序合成的突破点设计对话系统专属的语言)
  - [参考](#参考)

## 动机

- 动机：人工智能 如何 更 人性化的 和 用户 交流
- 待解决问题：
  - 任意复杂度的语义解析，海量服务的互联重组、超长对话的上下文追踪等一系列极具挑战性的问题

## 对话系统的三个挑战 何在？

- 在任务型对话中，用户的目的无外乎收集信息和解决问题
- 三段对话
  - 第一段对话的语句（下周二和Bree的经理开会后3小时的天气怎么样？）蕴含着丰富的语义信息：查询 Bree 和她经理的身份，查询下周二会面的时间地点，查询特定时间地点的天气等。系统必须正确地解析全部语义信息才有可能得到正确的答案。这引出了第一个问题：**怎样实现对任意语句的语义解析？**
  - 在第二段对话中，用户先查询了跑步活动的时间（我的下午跑步时间是？），接着将话题转移到天气上(那时的天气怎么样？)。虽然两个问题分属不同的领域，但考虑到对话的连续性，第二轮的查询应依赖于第一轮的结果。这引出了第二个问题：**怎样关联前后两轮对话的内容？怎样关联不同领域的服务？**
  - 第三段对话比较长。在这段对话中，用户首先查询了当天的安排（显示明天的安排），接着开始对一个特定会议（研究讨论组）进行询问和编辑。在这段对话中，我们观察到大量对上下文的引用("Jason", "研究组", "她", "它")和修改语句("那Diana呢", "重命名为", "修改为")。处理这些语言现象必须依赖前几轮获得的信息。这引出了第三个问题：**在多轮交互中，怎样准确地理解和利用上下文？**

## 现有 主流的任务型对话系统技术 介绍

### 意图识别和槽填充

- 学术界对语义理解的研究有着很多不同的思路，但在业界占主导地位的还是**基于意图识别(Intent classification)和槽填充(Slot filling)**的方案；
- 起源于1977年提出的[Genial Understander System框架](chrome-extension://ikhdkkncnoglghljlkmcimlnlhkeamad/pdf-viewer/web/viewer.html?file=https%3A%2F%2Fnlp.stanford.edu%2Facvogel%2Fgus.pdf)（简称GUS框架）;
- 优点：良好的可解释性、可扩展性和相对简单的实现而保持着强大的生命力
- GUS框架将语义理解分为三步：
  - 第一步，领域识别(Domain classification)，将用户的语句归入音乐、提醒、天气等领域。
  - 第二步，意图识别(Intent classification)，将语句进一步归入创建提醒、查询提醒、删除提醒等意图中。
  - 第三步，抽取用户语言中的实体(Entity)并填充意图的槽(Slot)。

### 意图识别的局限性

#### 问题一：长尾语句
  - 本质：在用语言表达一连串繁琐的机器操作，而对话系统的职责则是完成从自然语言到代码的转换。
  - 在GUS框架流程：这种转换是通过「领域-意图-槽」这个中间媒介进行的：
    - 首先，由语义理解模型完成从自然语言到「领域-意图-槽」的转换；
    - 接下来，由预设逻辑完成向代码的最终转换。
  - 问题：中间媒介的表示能力限定了语义理解能力的上限。如果用户的需求没有被注册在意图列表中，或者用户提供的信息无法被填充到特定的槽里，那么从语言到代码的转换必然会失败。
  - 原因：人类的语言是长尾的，即大部分语言无法被有限的高频意图所覆盖

- 问题介绍：枚举所有可能，针对所有意图，都必须为它的触发条件和行为编写代码，这意味高昂的开发维护成本；
  - 举例：
    - 「预约会议」可视作高频意图，但「在某会议后预约另一个会议」却并不高频；
    - 「查询天气」是高频意图，但「日出时气温是否较低」却不是；
    - 「设置壁纸」是高频意图，但「搜索照片并设为壁纸」却不是；
  
> 场景一：<br/>
> 组会结束后跟小王预约半小时的会议<br/>
> 明天泰山日出的时候会冷吗？<br/>
> 把昨天的合照设置为壁纸<br/>


#### 问题二：上下文理解
- 问题介绍：当用户的意图和前文相关时，开发者必须使用一个新意图来表示它

> 场景二：<br/>
> 用户：今天北京天气怎么样？<br/>
> 机器：8月1日，北京地区晴，气温27-35摄氏度<br/>
> 用户：那明天呢？<br/>
> 机器：8月2日，北京地区多云，气温25-32摄氏度<br/>
> 用户：空气质量怎么样？<br/>
> 机器：8月2日，北京地区空气质量为优<br/>

> 解析：语义理解模型将第二轮的意图识别为「查询天气-修改日期」。通过这个特定的意图，系统得知用户想查询天气情况，日期槽来自本轮，而其他槽来自前一轮的拷贝。如果开发者想为创建提醒、预约会议也实现类似的「修改」功能，则必须实现「创建提醒-修改日期」、「预约会议-修改日期」等意图。这无疑增加了代码量和数据收集的难度。系统需要从第一轮对话中提取地点，从第二轮对话中提取时间，再从第三轮对话提取具体的问题。为此，开发者不但要添加更多或更复杂的意图，而且语义理解的难度也随着对话的长度而不断上升。


#### 问题三：跨领域作业

- 问题介绍：可以对海量的第三方服务进行互联重组，构建出一个智能的超级服务。然而，如果在同一句话内涉及多领域的服务，「领域-意图-槽」的表示框架则常常力不从心

> 场景三：<br/>
> 用户：我和小周约在几点吃饭？<br/>
> 机器：上午12:30<br/>
> 用户：开车过去需要多久？<br/>
> 机器：从当前地点驾车到福临门餐厅需要20分钟<br/>

- 解析：
1. 提取第一轮对话提到的事件
2. 在日历中查找该事件的地点(福临门餐厅)
3. 调用GPS服务查找当前地点
4. 调用导航服务查询两个地点之间的驾驶时间

## 解决方法：程序合成

- 动机：既然意图和槽存在局限性，我们为什么不抛弃中间表示，让语义理解模型直接去合成代码呢？
- 方法：程序合成(Program synthesis)
- 存在问题：
  - 程序合成比较复杂
  - 标注和解析方面有额外的困难

### 举例说明

> 例子：用户：明天泰山日出的时候会冷吗？

- 程序

```s
val x0 = tomorrow()
describe(weatherForecast(
  dateTime = DateTime(
    date = x0, 
    time = sunriseTime(date = x0)
  ),
  place = searchPlace("泰山")
).temperature < ColdThreshold)
```

> 解析：述程序调用了4个外部API: tomorrow (返回明天的日期)，sunriseTime (返回日出时间)，searchPlace (返回地点)，weatherForecast (返回天气预报)，并利用 "temperature < ColdThreshold" 来刻画冷这个概念。最后，describe 函数将程序的运行结果转化为机器的回复。

- 优势：它善于对碎片化的函数和API进行组合，完成任意复杂的操作，从而大大提升了语义理解能力的上限。面对长尾需求，开发者不需编写新代码，只需有针对性地收集数据，训练语义理解模型，使它能合成出正确的程序即可。

### 程序合成的难点

#### 程序合成的难点：标注和解析

- 程序合成的核心难点：数据收集的困难；
  - 介绍：在意图识别系统中，标注人员首先为语句标出意图，接着在语句中圈出各个实体(如日期、时间、地点等)及其对应的槽位。这些都可以由非专业人士完成，成本相对低廉。而在程序合成系统中，标注人员必须在理解的基础上编写程序。一般来说，毫无编程经验的人难以胜任此类工作。即使是有一定编程经验并经过训练的人，进行程序标注的出错率也比标注「意图-槽」高得多。
- 程序合成的核心难点：语义解析；
  - 介绍：相比于意图识别(句子的多分类问题)和槽位识别(词的多分类问题)，程序合成的解空间要大得多，因为它包含所有可能的程序。

> 场景一：<br/>
> 用户：明天泰山日出的时候会冷吗？<br/>
> 机器：不会。8月2日早5:12，泰山地区天气晴，气温15摄氏度。<br/>
> 用户：能见度怎么样？<br/>

> 程序

```s
val x0 = tomorrow()
describe(weatherForecast(
  dateTime = DateTime(
    date = x0, 
    time = sunriseTime(date = x0)
  ),
  place = searchPlace("泰山")
).visibility)
```

> 解析：这段程序和第一轮的程序很像，只是把温度相关的操作换成了能见度。然而，合成这段程序十分困难，因为第二轮的语句中并未提及"明天"、"泰山"、"日出"等关键信息，必须从前文提取。

> 场景二：<br/>
> 那黄山呢？<br/>
> 后天的情况怎么样？<br/>
> 在那之前一小时提醒我起床<br/>

> 解析：这些都需要从前文提取信息并插入到程序中。相比于GUS框架基于意图的上下文表示，程序合成框架的上下文更复杂，提取和使用的出错率也更高。这对语义解析模型的设计提出了很高的要求。
> 对程序合成而言，标注的困难和解析的困难，最终都归结于同一个原因，即自然语言和机器语言的分歧。机器语言有别于我们日常所使用的语言，因此它要求标注者具有特定的逻辑思维，而解析它也依赖于更复杂的模型。训练更复杂的模型要求更多的数据，从而进一步推高了搭建成本。正因如此，在相同成本下，程序合成系统的投入产出比往往较低。
> 改进思路：设计一种对话系统专用的机器语言，通过提高和自然语言间的相似性来降低标注与解析的难度。

### 程序合成的突破点：设计对话系统专属的语言

- 使用者：标注人员和语义解析模型
- 满足基本功能【标准库】：支持基本的数据类型，如字符串、数字、数组、字典，以及对它们的基本操作，如加减乘除、对数组和字典的增删查改等
- 辅助功能：可以自由添加新的数据类型、函数和API
- 举例：

> 辅助函数
```s
  // 输入日期，返回那一天日出的日期和时间
  def dateTimeAtSunrise(date: Date): DateTime = {
    DateTime(
      date = date, 
      time = sunriseTime(date)
    )
  }

  // 输入天气预报，返回气温是否寒冷的布尔值
  def isCold(weatherForecast: WeatherForecast): Boolean = {
    weatherForecast.temperature < ColdThreshold
  }
```
> 程序简化<br/>
> 举例：用户：明天泰山日出的时候会冷吗？
```s
  describe(isCold(weatherForecast(
    dateTime = dateTimeAtSunrise(tomorrow()),
    place = searchPlace("泰山")
  ))) 
```
> 每个函数书写一条中文生成规则：
```s
  describe($1)            => 描述$1
  isCold($1)              => $1是否冷
  weatherForecast($1, $2) => $1$2的天气
  dateTimeAtSunrise($1)   => $1日出时
  tomorrow()              => 明天
  searchPlace($1)         => $1
```
- 规范语句(Canonical utterance)：每条规范语句都拥有与之对应的程序。对比自然语句和规范语句，我们发现后者可以视作前者的同义改写。
- 优点：
  - 有了规范语句，人们就可以使用自然语言(汉语)对文本进行标注，而系统通过逆向推理即可获得正确的程序；
  - 语义理解模型只需将用户语句规范化，即转化为相应的规范语句即可；
- 


## 参考

1. [解读微软最新的智能对话技术：用数据流合成实现任务型对话](https://zhuanlan.zhihu.com/p/245081650)
